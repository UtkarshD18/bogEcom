# ðŸ“Š Database Schema & Relationships

**Complete MongoDB schema definition with all collections and relationships**

---

## ðŸ—ï¸ Collection Structure

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         E-Commerce Database             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ users (authentication & profiles)     â”‚
â”‚ â€¢ products (catalog)                    â”‚
â”‚ â€¢ categories (product categories)       â”‚
â”‚ â€¢ orders (checkout & payments)          â”‚
â”‚ â€¢ carts (shopping carts)                â”‚
â”‚ â€¢ addresses (delivery addresses)        â”‚
â”‚ â€¢ wishlists (favorites)                 â”‚
â”‚ â€¢ banners (promotional content)         â”‚
â”‚ â€¢ homeSlides (homepage carousel)        â”‚
â”‚ â€¢ coupons (discount codes)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 1ï¸âƒ£ Orders Collection (Primary)

**Collection**: `orders`

**Purpose**: Store all customer orders with payment information

**Schema Definition**:

```javascript
{
  // Unique Identifiers
  _id: ObjectId,                                    // MongoDB auto-generated ID

  // User Information
  user: ObjectId,                                   // Reference to User collection
                                                    // Can be null for guest checkout

  // Product Details
  products: [
    {
      productId: String,                            // Reference to product ID
      productTitle: String,                         // Product name (snapshot)
      quantity: Number,                             // Items ordered (min: 1)
      price: Number,                                // Price per unit at time of order
      image: String,                                // Product image URL
      subTotal: Number,                             // quantity * price
      _id: ObjectId                                 // Subdocument ID
    }
  ],

  // Payment Information (Razorpay)
  paymentId: String,                                // Razorpay Payment ID
                                                    // Indexed for fast lookup
                                                    // Example: pay_IluGWxBm9U8zJ8

  razorpayOrderId: String,                          // Razorpay Order ID
                                                    // Indexed for reference
                                                    // Example: order_IluGWxBm9U8zJ8

  razorpaySignature: String,                        // Signature for verification
                                                    // HMAC-SHA256 hash

  // Order Status
  payment_status: String,                           // Enum: pending, paid, failed
                                                    // Indexed for filtering

  order_status: String,                             // Enum: pending, confirmed,
                                                    // shipped, delivered, cancelled
                                                    // Indexed for filtering

  // Delivery Details
  delivery_address: ObjectId,                       // Reference to Address collection
                                                    // Snapshot address at time of order

  // Financial Information
  totalAmt: Number,                                 // Total order amount (in INR)
                                                    // Minimum: 0

  discount: Number,                                 // Discount amount applied
                                                    // Default: 0

  tax: Number,                                      // Tax/GST amount
                                                    // Default: 0

  shipping: Number,                                 // Shipping charges
                                                    // Default: 0

  // Additional Information
  notes: String,                                    // Order notes/instructions
                                                    // Default: ""

  failureReason: String,                            // Reason if payment failed
                                                    // Example: "Card declined",
                                                    // "Insufficient balance"

  // Audit Trail
  lastUpdatedBy: ObjectId,                          // Admin who updated order status
                                                    // Reference to User collection

  // Timestamps
  createdAt: Date,                                  // Order creation time
                                                    // Auto-generated by Mongoose

  updatedAt: Date                                   // Last update time
                                                    // Auto-updated on any change
}
```

**Indexes**:

```javascript
{
  paymentId: 1                                      // Fast lookup by payment
}

{
  user: 1,
  createdAt: -1                                     // User orders sorted by date
}

{
  payment_status: 1,
  order_status: 1                                   // Filter by status
}
```

**Example Document**:

```javascript
{
  _id: ObjectId("507f1f77bcf86cd799439013"),
  user: ObjectId("507f1f77bcf86cd799439000"),
  products: [
    {
      productId: "507f1f77bcf86cd799439011",
      productTitle: "Organic Peanut Butter",
      quantity: 2,
      price: 300,
      image: "https://cdn.example.com/peanut-butter.jpg",
      subTotal: 600,
      _id: ObjectId("507f1f77bcf86cd799439014")
    },
    {
      productId: "507f1f77bcf86cd799439015",
      productTitle: "Almond Oil",
      quantity: 1,
      price: 500,
      image: "https://cdn.example.com/almond-oil.jpg",
      subTotal: 500,
      _id: ObjectId("507f1f77bcf86cd799439016")
    }
  ],
  paymentId: "pay_IluGWxBm9U8zJ8",
  razorpayOrderId: "order_IluGWxBm9U8zJ8",
  razorpaySignature: "9ef4dffbfd84f1318f6739a3ce19f9d85851857ae648f114332d8401e0949a3d",
  payment_status: "paid",
  order_status: "confirmed",
  delivery_address: ObjectId("507f1f77bcf86cd799439017"),
  totalAmt: 1150,
  discount: 0,
  tax: 0,
  shipping: 50,
  notes: "Please deliver in the morning",
  failureReason: null,
  lastUpdatedBy: ObjectId("507f1f77bcf86cd799439099"),
  createdAt: ISODate("2026-01-25T10:30:00Z"),
  updatedAt: ISODate("2026-01-25T11:00:00Z")
}
```

---

## 2ï¸âƒ£ Related Collections

### **Users Collection**

```javascript
{
  _id: ObjectId,
  name: String,
  email: String (unique),
  password: String (hashed with bcrypt),
  avatar: String (URL),
  mobile: String,
  isAdmin: Boolean,
  createdAt: Date,
  updatedAt: Date
}
```

**Relationship**: `orders.user â†’ users._id`

---

### **Products Collection**

```javascript
{
  _id: ObjectId,
  productTitle: String,
  image: [String],
  description: String,
  price: Number,
  category: ObjectId (ref: categories),
  rating: Number,
  reviews: [ObjectId] (ref: reviews),
  stock: Number,
  createdAt: Date,
  updatedAt: Date
}
```

**Relationship**: `orders.products[].productId â†’ products._id`

---

### **Address Collection**

```javascript
{
  _id: ObjectId,
  user: ObjectId (ref: users),
  addressLine1: String,
  addressLine2: String,
  city: String,
  state: String,
  zipCode: String,
  country: String,
  isDefault: Boolean,
  phone: String,
  createdAt: Date,
  updatedAt: Date
}
```

**Relationship**: `orders.delivery_address â†’ addresses._id`

---

## ðŸ”„ Order Lifecycle & Status Flow

```
ORDER CREATION
      â†“
   pending (awaiting payment)
      â†“
   [Payment Processing]
      â†“
   â”Œâ”€â†’ paid (payment successful)
   â”‚      â†“
   â”‚   confirmed (ready to ship)
   â”‚      â†“
   â”‚   shipped (in transit)
   â”‚      â†“
   â”‚   delivered âœ… (order complete)
   â”‚
   â””â”€â†’ failed (payment declined)
          â†“
       cancelled âŒ (order cancelled)
```

**Status Transitions**:

- `pending` â†’ `confirmed`: After payment verification
- `confirmed` â†’ `shipped`: When admin ships order
- `shipped` â†’ `delivered`: When customer receives
- Any status â†’ `cancelled`: If order cancelled

---

## ðŸ“Š Payment Status

| Status    | Meaning                 | Next Step             |
| --------- | ----------------------- | --------------------- |
| `pending` | Payment not yet made    | Waiting for checkout  |
| `paid`    | Payment successful      | Update order_status   |
| `failed`  | Payment declined/failed | Allow retry or cancel |

---

## ðŸ“¦ Order Status

| Status      | Meaning                 | Customer Action   |
| ----------- | ----------------------- | ----------------- |
| `pending`   | Awaiting confirmation   | Initiate payment  |
| `confirmed` | Payment received, ready | Wait for shipping |
| `shipped`   | Package in transit      | Track delivery    |
| `delivered` | Received by customer    | Leave review      |
| `cancelled` | Order cancelled         | Contact support   |

---

## ðŸ” Query Examples

### **Get User's Orders**

```javascript
OrderModel.find({
  user: userId,
})
  .sort({ createdAt: -1 })
  .populate("user", "name email")
  .populate("delivery_address");
```

**Result**: Array of orders with user and address details

---

### **Get Paid Orders**

```javascript
OrderModel.find({
  payment_status: "paid",
}).sort({ createdAt: -1 });
```

**Result**: All successfully paid orders

---

### **Get Orders by Status**

```javascript
OrderModel.find({
  order_status: "shipped",
}).populate("user", "name email mobile");
```

**Result**: All orders currently in transit

---

### **Calculate Revenue**

```javascript
OrderModel.aggregate([
  {
    $match: {
      payment_status: "paid",
      createdAt: {
        $gte: new Date("2026-01-01"),
        $lt: new Date("2026-02-01"),
      },
    },
  },
  {
    $group: {
      _id: null,
      totalRevenue: { $sum: "$totalAmt" },
      orderCount: { $sum: 1 },
      avgOrderValue: { $avg: "$totalAmt" },
    },
  },
]);
```

**Result**:

```javascript
{
  _id: null,
  totalRevenue: 4560000,
  orderCount: 156,
  avgOrderValue: 29230.77
}
```

---

### **Get Order Statistics**

```javascript
OrderModel.aggregate([
  {
    $group: {
      _id: "$order_status",
      count: { $sum: 1 },
      revenue: {
        $sum: {
          $cond: [{ $eq: ["$payment_status", "paid"] }, "$totalAmt", 0],
        },
      },
    },
  },
]);
```

**Result**:

```javascript
[
  { _id: "confirmed", count: 98, revenue: 2850000 },
  { _id: "shipped", count: 35, revenue: 1050000 },
  { _id: "delivered", count: 10, revenue: 300000 },
  { _id: "pending", count: 12, revenue: 0 },
  { _id: "cancelled", count: 1, revenue: 0 },
];
```

---

### **Find Failed Payments**

```javascript
OrderModel.find({
  payment_status: "failed",
})
  .select("paymentId failureReason user totalAmt createdAt")
  .sort({ createdAt: -1 });
```

**Result**: List of failed payment attempts

---

### **Get Recent Orders**

```javascript
OrderModel.find()
  .sort({ createdAt: -1 })
  .limit(10)
  .populate("user", "name email avatar");
```

**Result**: Last 10 orders with user info

---

## ðŸš€ Performance Optimization

### **Index Strategy**

1. **Payment Lookup** (High Priority)

   ```javascript
   db.orders.createIndex({ paymentId: 1 });
   ```

   - Used in: Payment verification
   - Speed: ~1ms on 100K documents

2. **User Orders** (Medium Priority)

   ```javascript
   db.orders.createIndex({ user: 1, createdAt: -1 });
   ```

   - Used in: Fetch user's orders
   - Speed: ~5ms with sorting

3. **Status Filtering** (Medium Priority)
   ```javascript
   db.orders.createIndex({ payment_status: 1, order_status: 1 });
   ```

   - Used in: Admin filtering
   - Speed: ~10ms on 100K documents

### **Query Optimization**

```javascript
// âŒ SLOW: No index, full collection scan
OrderModel.find({ paymentId: "pay_xxx" });

// âœ… FAST: Using index
OrderModel.find({ paymentId: "pay_xxx" }).lean();

// âŒ SLOW: Returns all fields
OrderModel.find().lean();

// âœ… FAST: Select only needed fields
OrderModel.find()
  .select("order_status payment_status totalAmt createdAt")
  .lean();

// âŒ SLOW: No pagination
OrderModel.find().populate("user");

// âœ… FAST: Paginated results
OrderModel.find()
  .skip((page - 1) * limit)
  .limit(limit)
  .populate("user", "name email"); // Select fields from user
```

---

## ðŸ’¾ Data Persistence

### **Order Creation Flow**

```
1. API receives request
2. Validate data
3. Create Razorpay order
4. Save OrderModel to MongoDB
5. Return orderId + razorpayOrderId
```

### **Payment Verification Flow**

```
1. API receives payment details
2. Verify HMAC signature
3. If valid:
   - Update: payment_status = 'paid'
   - Update: order_status = 'confirmed'
   - Save to MongoDB
   - Return success
4. If invalid:
   - Update: order_status = 'cancelled'
   - Save to MongoDB
   - Return error
```

---

## ðŸ” Data Security

### **Never Store**

- âŒ Credit card numbers
- âŒ CVV codes
- âŒ Sensitive payment details

### **Always Store**

- âœ… Razorpay Payment ID (for reference)
- âœ… Order amount (for auditing)
- âœ… Order status (for tracking)
- âœ… User ID (for ownership)
- âœ… Timestamps (for audit trail)

### **Sensitive Data Handling**

```javascript
// âœ… GOOD: Store only payment reference
{
  paymentId: "pay_xxx",      // Safe to store
  razorpaySignature: "hash"  // Already hashed
}

// âŒ BAD: Never store card details
{
  cardNumber: "4111...",      // NEVER!
  cvv: "123"                  // NEVER!
}
```

---

## ðŸ“ˆ Capacity Planning

### **Current Indexes**

- `paymentId`: ~1MB per 100K orders
- `user + createdAt`: ~2MB per 100K orders
- `payment_status + order_status`: ~1.5MB per 100K orders

**Total**: ~4.5MB per 100K orders

### **Document Size**

- Average document: ~1.2KB
- 100K orders: ~120MB
- Storage with indexes: ~150MB

### **Scaling Recommendations**

- **Up to 1M orders**: Single MongoDB instance
- **1M - 10M orders**: Sharding by user ID
- **10M+ orders**: Partition by date + sharding

---

## ðŸ”„ Backup & Recovery

### **Recommended Backup Strategy**

```javascript
// Daily snapshots
mongodump --uri "mongodb+srv://..." \
  --out /backups/orders-$(date +%Y-%m-%d)

// Enable Point-in-Time Recovery
// MongoDB Atlas â†’ Backup â†’ Enable PITR

// Test restore quarterly
mongorestore --uri "mongodb+srv://..." \
  --dir /backups/test-restore
```

### **Recovery Procedures**

**If payment verification fails:**

```javascript
// Mark as failed but keep order
OrderModel.findByIdAndUpdate(orderId, {
  payment_status: "failed",
  failureReason: "Signature mismatch",
});

// User can retry payment later
```

**If order gets corrupted:**

```javascript
// Restore from backup
mongorestore --uri "..." --drop

// Verify order in restored state
OrderModel.findById(orderId)
```

---

## ðŸ“Š Monitoring Queries

### **Track Database Size**

```javascript
db.orders.stats();

// Returns: size, avgObjSize, count, indexSizes
```

### **Check Index Usage**

```javascript
db.orders.aggregate([{ $indexStats: {} }]);

// Shows: index size, usage count, last access time
```

### **Slow Query Log**

```javascript
db.setProfilingLevel(1, { slowms: 100 });

// Logs queries taking > 100ms
```

---

**Last Updated**: January 25, 2026

**Status**: âœ… Production Ready

_For API endpoints, see [API_QUICK_REFERENCE.md](API_QUICK_REFERENCE.md)_
_For complete setup, see [README.md](README.md)_
