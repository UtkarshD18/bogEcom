name: Deploy Client (App Engine)

on:
  push:
    branches:
      - main
      - master
    paths:
      - "frontend/client/**"
      - ".github/workflows/deploy-client.yml"
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: deploy-client
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Build temporary client deploy YAML
        env:
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}
          NEXT_PUBLIC_APP_API_URL: ${{ secrets.NEXT_PUBLIC_APP_API_URL }}
          NEXT_PUBLIC_SITE_URL: ${{ secrets.NEXT_PUBLIC_SITE_URL }}
          NEXT_PUBLIC_FIREBASE_API_KEY: ${{ secrets.NEXT_PUBLIC_FIREBASE_API_KEY }}
          NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: ${{ secrets.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN }}
          NEXT_PUBLIC_FIREBASE_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_PROJECT_ID }}
          NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET: ${{ secrets.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET }}
          NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID }}
          NEXT_PUBLIC_FIREBASE_APP_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_APP_ID }}
          NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID }}
          NEXT_PUBLIC_FIREBASE_VAPID_KEY: ${{ secrets.NEXT_PUBLIC_FIREBASE_VAPID_KEY }}
          NEXT_PUBLIC_GOOGLE_MAPS_API_KEY: ${{ secrets.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY }}
        run: |
          python - <<'PY'
          import json
          import os
          import sys

          api_url = os.environ.get("NEXT_PUBLIC_API_URL", "").strip()
          if not api_url:
              sys.exit("Missing required GitHub repository secret: NEXT_PUBLIC_API_URL")

          site_url = os.environ.get("NEXT_PUBLIC_SITE_URL", "").strip()
          if not site_url:
              site_url = "https://client-dot-healthy-one-gram.el.r.appspot.com"

          firebase_core_keys = [
              "NEXT_PUBLIC_FIREBASE_API_KEY",
              "NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN",
              "NEXT_PUBLIC_FIREBASE_PROJECT_ID",
              "NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET",
              "NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID",
              "NEXT_PUBLIC_FIREBASE_APP_ID",
          ]
          provided_firebase_core = [
              key for key in firebase_core_keys if os.environ.get(key, "").strip()
          ]
          if 0 < len(provided_firebase_core) < len(firebase_core_keys):
              sys.exit(
                  "Partial Firebase client secrets detected. "
                  "Provide all or none: " + ", ".join(firebase_core_keys)
              )

          app_api_url = os.environ.get("NEXT_PUBLIC_APP_API_URL", "").strip()
          if not app_api_url:
              app_api_url = api_url

          public_env = {
              "NEXT_PUBLIC_API_URL": api_url,
              "NEXT_PUBLIC_APP_API_URL": app_api_url,
              "NEXT_PUBLIC_SITE_URL": site_url,
          }

          optional_public_keys = [
              "NEXT_PUBLIC_FIREBASE_API_KEY",
              "NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN",
              "NEXT_PUBLIC_FIREBASE_PROJECT_ID",
              "NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET",
              "NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID",
              "NEXT_PUBLIC_FIREBASE_APP_ID",
              "NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID",
              "NEXT_PUBLIC_FIREBASE_VAPID_KEY",
              "NEXT_PUBLIC_GOOGLE_MAPS_API_KEY",
          ]
          for key in optional_public_keys:
              value = os.environ.get(key, "").strip()
              if value:
                  public_env[key] = value

          if len(provided_firebase_core) == len(firebase_core_keys):
              sw_path = "frontend/client/public/firebase-messaging-sw.js"
              with open(sw_path, "r", encoding="utf-8") as f:
                  sw_content = f.read()

              replacements = {
                  "__NEXT_PUBLIC_FIREBASE_API_KEY__": os.environ["NEXT_PUBLIC_FIREBASE_API_KEY"].strip(),
                  "__NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN__": os.environ["NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN"].strip(),
                  "__NEXT_PUBLIC_FIREBASE_PROJECT_ID__": os.environ["NEXT_PUBLIC_FIREBASE_PROJECT_ID"].strip(),
                  "__NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET__": os.environ["NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET"].strip(),
                  "__NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID__": os.environ["NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID"].strip(),
                  "__NEXT_PUBLIC_FIREBASE_APP_ID__": os.environ["NEXT_PUBLIC_FIREBASE_APP_ID"].strip(),
              }

              for placeholder, value in replacements.items():
                  sw_content = sw_content.replace(placeholder, value)

              with open(sw_path, "w", encoding="utf-8") as f:
                  f.write(sw_content)

          lines = [
              "runtime: nodejs22",
              "service: client",
              "",
              "build_env_variables:",
          ]
          for key, value in public_env.items():
              lines.append(f"  {key}: {json.dumps(value)}")

          lines.extend([
              "",
              "env_variables:",
          ])
          for key, value in public_env.items():
              lines.append(f"  {key}: {json.dumps(value)}")

          with open("frontend/client/app.deploy.yaml", "w", encoding="utf-8") as f:
              f.write("\n".join(lines) + "\n")
          PY

      - name: Deploy client service
        run: gcloud app deploy frontend/client/app.deploy.yaml --project="${{ secrets.GCP_PROJECT_ID }}" --quiet

      - name: Cleanup
        if: always()
        run: rm -f frontend/client/app.deploy.yaml
